name: Deploy Dev (Kustomize)
on:
    push:
        branches: [dev]
        paths: ["overlays/dev/**", "base/**"]
    pull_request:
        branches: [dev]
        paths: ["overlays/dev/**", "base/**"]

jobs:
    deploy-dev:
        runs-on: ubuntu-latest
        environment: dev
        steps:
            - uses: actions/checkout@v4

            # Install Kustomize directly
            - name: Install Kustomize
              run: |
                  KUSTOMIZE_VERSION=v5.3.0
                  curl -sLO "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KUSTOMIZE_VERSION}/kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
                  tar xzf kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz
                  sudo mv kustomize /usr/local/bin/

            # Install kubectl directly
            - name: Install kubectl
              run: |
                  curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                  chmod +x kubectl
                  sudo mv kubectl /usr/local/bin/

            - name: Deploy to K3s-Dev
              env:
                  KUBECONFIG: ${{ secrets.K3S_DEV_KUBECONFIG }}
              run: |
                  echo "$KUBECONFIG" | base64 -d > kubeconfig.yaml
                  export KUBECONFIG=kubeconfig.yaml
                  kustomize build --load-restrictor LoadRestrictionsNone overlays/dev | kubectl apply -f -
                  kubectl rollout status deployment/kratos -n kratos-dev --timeout=300s
