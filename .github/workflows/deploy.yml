name: Deploy to Dev K8s

on:
  push:
    branches: [dev]
    paths:
      - "overlays/dev/**"
      - "base/**"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, k3s, dev]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: kustomize-everything/action-kustomize@v1
        with:
          kustomize_version: v5.3.0

      - name: Install kubeval
        run: |
          curl -sSL https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz \
          | tar xz
          sudo mv kubeval /usr/local/bin

      - name: Validate manifests
        run: |
          kustomize build overlays/dev | kubeval --strict

      - name: Deploy to k3s
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          kubectl config set-context --current --namespace=k8s-begining-dev
          kustomize build overlays/dev | kubectl apply -f -
          kubectl rollout status deployment --all --timeout=300s

      - name: Post-deploy check
        run: |
          kubectl get all
