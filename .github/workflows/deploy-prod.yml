name: Deploy Prod (Kustomize)
on:
    push:
        branches: [main]
        paths: ["overlays/prod/**", "base/**"]
    pull_request:
        branches: [main]
        paths: ["overlays/prod/**", "base/**"]

jobs:
    deploy-prod:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            # Install Kustomize directly
            - name: Install Kustomize
              run: |
                  KUSTOMIZE_VERSION=v5.3.0
                  curl -sLO "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KUSTOMIZE_VERSION}/kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
                  tar xzf kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz
                  sudo mv kustomize /usr/local/bin/

            # Install kubectl directly
            - name: Install kubectl
              run: |
                  KUBECTL_VERSION=v1.29.0
                  curl -sLO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
                  chmod +x kubectl
                  sudo mv kubectl /usr/local/bin/

            - name: Deploy to K3s-Prod
              env:
                  KUBECONFIG_B64: ${{ secrets.K3S_PROD_KUBECONFIG }}
              run: |
                  echo "$KUBECONFIG_B64" | base64 -d > $HOME/kubeconfig.yaml
                  export KUBECONFIG=$HOME/kubeconfig.yaml
                  kustomize build --load-restrictor LoadRestrictionsNone overlays/prod | kubectl apply -f -
                  kubectl rollout status deployment/prod-kratos -n kratos-prod --timeout=300s
